<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- mapbox -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.0/mapbox-gl.js"></script>

    <style>
      body {
        padding: 1rem;
      }

      #map {
        width: 100%;
        height: 400px;
        border-radius: 1rem;
      }

      .marker {
        background-color: #ff0000;
        border: 6px solid rgb(255, 121, 121);
        width: 14px;
        height: 14px;
        border-radius: 50%;
        cursor: pointer;
      }

      .popup {
        background-color: transparent;
      }

      .popup h3 {
        margin: 0;
      }

      .popup .mapboxgl-popup-content {
        padding: 1rem;
        background-color: white;
        border-radius: 1rem;
        box-shadow: none;
      }
    </style>

    <title>Social Media</title>
  </head>
  <body>
    <h1>Social Media Map</h1>
    <div id="map"></div>

    <script>
      const SERVER = '<%= SERVER %>';
      const MAPBOX_TOKEN = '<%= MAPBOX_TOKEN %>';

      const gpsOptions = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0,
      };

      const getThreats = async () => {
        try {
          const response = await fetch(`${SERVER}/threads`);

          if (response.status !== 200) {
            throw new Error('Failed to fetch');
          }

          const responseJson = await response.json();

          return responseJson.data;
        } catch (error) {
          console.log(error);
          return [];
        }
      };

      const createMapMarker = () => {
        const markerElement = document.createElement('div');
        markerElement.className = 'marker';
        return markerElement;
      };

      const success = async ({ coords }) => {
        mapboxgl.accessToken = MAPBOX_TOKEN;
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [coords.longitude, coords.latitude],
          zoom: 10,
        });

        map.addControl(new mapboxgl.NavigationControl());

        const { threads } = await getThreats();

        threads.forEach((thread) => {
          const popup = new mapboxgl.Popup({ className: 'popup' }).setHTML(
            `<div>
              <img src="/marker.png" width="20"/>
              <h3>${thread.caption}</h3>
            </div>`
          );

          new mapboxgl.Marker(createMapMarker())
            .setLngLat([thread.longitude, thread.latitude])
            .setPopup(popup)
            .addTo(map);
        });
      };

      const error = (errpr) => {
        console.log(error);
      };

      navigator.geolocation.getCurrentPosition(success, error, gpsOptions);
    </script>
  </body>
</html>
